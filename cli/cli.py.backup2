"""
Interfaz de l√≠nea de comandos para Backgammon.

Este m√≥dulo proporciona una CLI completa con visualizaci√≥n ASCII del tablero,
gesti√≥n de comandos interactivos y feedback visual detallado.
"""

from core.game import BackgammonJuego


class BackgammonCLI:
    """
    Interfaz de l√≠nea de comandos para Backgammon.
    
    Proporciona una interfaz interactiva con visualizaci√≥n del tablero,
    gesti√≥n de comandos y feedback visual para los jugadores.
    
    Attributes:
        __juego__: Instancia del juego de Backgammon
    """
    
    def __init__(self):
    """Inicializa la CLI con una nueva instancia del juego."""
    self.__juego__ = BackgammonJuego()

    def mostrar_tablero_visual(self):
        """
        Muestra una representaci√≥n visual del tablero en formato ASCII.
        
        El tablero se muestra dividido en dos mitades:
        - Superior: puntos 13-24
        - Inferior: puntos 12-1
        
        Las fichas se representan con s√≠mbolos:
        - 'X' para jugador 1 (blancas)
        - 'O' para jugador 2 (negras)
        - N√∫meros cuando hay m√°s de 5 fichas en un punto
        """
        tablero = self.__juego.tablero
        
        print("\n" + "=" * 80)
        print("                        üé≤ BACKGAMMON - TABLERO üé≤")
        print("=" * 80)
        
        # Encabezado superior (puntos 13-24)
        print("\n  13  14  15  16  17  18 |BAR| 19  20  21  22  23  24")
        print(" " + "-" * 77)
        
        # Parte superior del tablero
        self._mostrar_mitad_superior(tablero)
        
        print(" " + "-" * 77)
        
        # Parte inferior del tablero
        self._mostrar_mitad_inferior(tablero)
        
        print(" " + "-" * 77)
        print("  12  11  10   9   8   7 |BAR|  6   5   4   3   2   1")
        
        # Informaci√≥n adicional
        self._mostrar_info_barra()
        self._mostrar_dados_disponibles()
        
        print("=" * 80 + "\n")

    def _mostrar_mitad_superior(self, tablero):
        """
        Muestra la mitad superior del tablero (puntos 13-24).
        
        Args:
            tablero: Instancia de Tablero con el estado actual
        """
        max_altura = 5
        
        for fila in range(max_altura):
            linea = " "
            
            # Puntos 13-18
            for punto in range(12, 18):
                simbolo = self._obtener_simbolo_para_punto(tablero, punto, fila)
                linea += f" {simbolo}  "
            
            # Barra (muestra fichas capturadas)
            linea += self._formato_barra(fila)
            
            # Puntos 19-24
            for punto in range(18, 24):
                simbolo = self._obtener_simbolo_para_punto(tablero, punto, fila)
                linea += f" {simbolo}  "
            
            print(linea)

    def _mostrar_mitad_inferior(self, tablero):
        """
        Muestra la mitad inferior del tablero (puntos 1-12).
        
        Args:
            tablero: Instancia de Tablero con el estado actual
        """
        max_altura = 5
        
        for fila in range(max_altura - 1, -1, -1):
            linea = " "
            
            # Puntos 12-7 (invertidos para visualizaci√≥n)
            for punto in range(11, 5, -1):
                simbolo = self._obtener_simbolo_para_punto(tablero, punto, fila)
                linea += f" {simbolo}  "
            
            # Barra (espacio vac√≠o en mitad inferior)
            linea += "|  | "
            
            # Puntos 6-1 (invertidos para visualizaci√≥n)
            for punto in range(5, -1, -1):
                simbolo = self._obtener_simbolo_para_punto(tablero, punto, fila)
                linea += f" {simbolo}  "
            
            print(linea)

    def _obtener_simbolo_para_punto(self, tablero, punto, fila):
        """
        Obtiene el s√≠mbolo a mostrar para un punto en una fila espec√≠fica.
        
        Args:
            tablero: Instancia de Tablero
            punto: N√∫mero del punto (0-23)
            fila: N√∫mero de fila (0-4)
            
        Returns:
            str: S√≠mbolo a mostrar ('X', 'O', n√∫mero o espacio)
        """
        cantidad = tablero.fichas_en(punto)
        
        if cantidad == 0:
            return " "
        
        if fila < min(cantidad, 5):
            # Mostrar la ficha correspondiente
            ficha = tablero.ficha_en(punto)
            return ficha if ficha else " "
        elif fila == 4 and cantidad > 5:
            # Si hay m√°s de 5 fichas, mostrar el n√∫mero en la √∫ltima fila
            return str(cantidad)
        
        return " "

    def _formato_barra(self, fila):
        """
        Formatea la visualizaci√≥n de la barra con fichas capturadas.
        
        Args:
            fila: N√∫mero de fila (0-4)
            
        Returns:
            str: String formateado para la barra
        """
        barra_x = len(self.__juego.tablero.barra_x)
        barra_o = len(self.__juego.tablero.barra_o)
        
        linea = "|"
        if fila == 0 and barra_x > 0:
            linea += f"X{barra_x:1d}"
        elif fila == 1 and barra_o > 0:
            linea += f"O{barra_o:1d}"
        else:
            linea += "  "
        linea += "| "
        
        return linea

    def _mostrar_info_barra(self):
        """Muestra informaci√≥n sobre fichas capturadas en la barra."""
        barra_x = len(self.__juego.tablero.barra_x)
        barra_o = len(self.__juego.tablero.barra_o)
        
        if barra_x > 0 or barra_o > 0:
            print(f"\n üìä Fichas en barra: X={barra_x}, O={barra_o}")
            if barra_x > 0:
                print("    ‚ö†Ô∏è  Jugador X debe reingresar fichas desde la barra")
            if barra_o > 0:
                print("    ‚ö†Ô∏è  Jugador O debe reingresar fichas desde la barra")

    def _mostrar_dados_disponibles(self):
        """Muestra los dados disponibles para usar en el turno actual."""
        if hasattr(self.__juego, 'movimientos_disponibles'):
            movimientos = self.__juego.movimientos_disponibles()
            if movimientos:
                print(f" üé≤ Dados disponibles: {movimientos}")
                print(f" üë§ Turno actual: Jugador {'X' if self.__juego.turno == 1 else 'O'}")
            else:
                print(f" üë§ Turno: Jugador {'X' if self.__juego.turno == 1 else 'O'} - Sin dados disponibles")

    def mostrar_ayuda(self):
        """
        Muestra la lista de comandos disponibles con descripciones detalladas.
        
        Incluye ejemplos de uso y tips para una mejor experiencia.
        """
        print("\n" + "=" * 70)
        print("                    üìã COMANDOS DISPONIBLES")
        print("=" * 70)
        print("\n  VISUALIZACI√ìN:")
        print("    tablero         - Muestra el tablero visual completo")
        print("    estado          - Muestra el estado resumido del juego")
        print("    ayuda           - Muestra esta ayuda")
        print("\n  ACCIONES DEL JUEGO:")
        print("    tirar           - Tira los dados (inicia tu turno)")
        print("    mover X Y       - Mueve ficha del punto X al punto Y")
        print("                      Ejemplo: mover 6 4")
        print("    mover -1 Y      - Reingresa ficha desde la barra al punto Y")
        print("                      Ejemplo: mover -1 5")
        print("\n  GESTI√ìN:")
        print("    reiniciar       - Reinicia el juego desde cero")
        print("    salir           - Sale del juego")
        print("\n  üí° TIPS:")
        print("    ‚Ä¢ Los puntos se numeran de 1 a 24")
        print("    ‚Ä¢ Usa -1 como origen para reingresar desde la barra")
        print("    ‚Ä¢ Debes usar todos los dados disponibles antes de cambiar turno")
        print("    ‚Ä¢ Si no puedes mover, el turno pasa autom√°ticamente")
        print("=" * 70 + "\n")

    def mostrar_bienvenida(self):
        """Muestra el mensaje de bienvenida con arte ASCII."""
        print("\n" + "=" * 80)
        print("""
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë                                                                       ‚ïë
    ‚ïë               üé≤  B A C K G A M M O N  -  C L I  üé≤                  ‚ïë
    ‚ïë                                                                       ‚ïë
    ‚ïë                   ¬°Bienvenido al juego de estrategia                 ‚ïë
    ‚ïë                         m√°s antiguo del mundo!                        ‚ïë
    ‚ïë                                                                       ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        """)
        print("=" * 80)
        print("\n  üìñ Reglas b√°sicas:")
        print("     ‚Ä¢ Cada jugador debe mover todas sus fichas hacia su home")
        print("     ‚Ä¢ Los movimientos se hacen seg√∫n los dados tirados")
        print("     ‚Ä¢ Captura fichas del oponente dej√°ndolas en puntos solitarios")
        print("     ‚Ä¢ Gana quien saque todas sus fichas del tablero primero")
        print("\n" + "=" * 80 + "\n")

    def iniciar(self):
        """
        Inicia el juego desde la CLI y entra en un loop de comandos.
        
        Gestiona el flujo del juego, procesa comandos del usuario y
        verifica condiciones de victoria.
        """
        self.mostrar_bienvenida()
        self.__juego.iniciar()
        print("‚úÖ El juego ha comenzado. ¬°Buena suerte!")
        self.mostrar_ayuda()
        self.mostrar_tablero_visual()
        self.mostrar_estado()

        while True:
            # Verificar si hay ganador
            ganador = self.__juego.verificar_ganador()
            if ganador:
                self._mostrar_victoria(ganador)
            
            cmd = input("\n> ").strip().lower()
            
            if not cmd:
                continue
            
            if cmd in ("salir", "exit", "q"):
                self.salir()
                break
            
            if cmd in ("ayuda", "help", "h", "?"):
                self.mostrar_ayuda()
                continue
            
            if cmd == "tablero":
                self.mostrar_tablero_visual()
                continue
            
            if cmd == "estado":
                self.mostrar_estado()
                continue
            
            if cmd == "reiniciar":
                self.reiniciar_juego()
                continue
            
            if cmd == "tirar":
                self._procesar_tirada(ganador)
                continue
            
            if cmd.startswith("mover"):
                self._procesar_movimiento(cmd, ganador)
                continue
            
            print("‚ùå Comando no reconocido. Escribe 'ayuda' para ver los comandos disponibles.")

    def _mostrar_victoria(self, ganador):
        """
        Muestra el mensaje de victoria con formato especial.
        
        Args:
            ganador: Identificador del jugador ganador
        """
        print("\n" + "üéâ" * 40)
        print("\n              ¬°¬°¬° F E L I C I T A C I O N E S !!!")
        print(f"\n                El Jugador {ganador} ha GANADO")
        print("\n" + "üéâ" * 40)
        print("\n  Puedes escribir 'reiniciar' para jugar de nuevo")
        print("  o 'salir' para terminar.\n")

    def _procesar_tirada(self, ganador):
        """
        Procesa el comando de tirar dados.
        
        Args:
            ganador: Identificador del ganador (None si no hay)
        """
        if ganador:
            print("‚ö†Ô∏è  La partida ya termin√≥. Reinicia para jugar de nuevo.")
            return
        
        vals = self.__juego.tirar_dados()
        movs = self.__juego.movimientos_disponibles()
        
        print(f"\nüé≤ Dados tirados: {vals}")
        print(f"üìä Movimientos disponibles: {movs}")
        
        if not movs:
            print("‚ö†Ô∏è  No hay movimientos posibles con estos dados.")
            print("‚è≠Ô∏è  Cambiando turno autom√°ticamente...")
            self.__juego.cambiar_turno()
            jugador_actual = 'X' if self.__juego.turno == 1 else 'O'
            print(f"üîÑ Turno del Jugador {jugador_actual}")

    def _procesar_movimiento(self, cmd, ganador):
        """
        Procesa el comando de mover ficha.
        
        Args:
            cmd: Comando ingresado por el usuario
            ganador: Identificador del ganador (None si no hay)
        """
        if ganador:
            print("‚ö†Ô∏è  La partida ya termin√≥. Reinicia para jugar de nuevo.")
            return
        
        parts = cmd.split()
        if len(parts) != 3:
            print("‚ùå Uso incorrecto del comando mover")
            print("   Formato: mover <origen> <destino>")
            print("   Ejemplo: mover 6 4  (mueve ficha del punto 6 al 4)")
            print("   Ejemplo: mover -1 5  (reingresa desde barra al punto 5)")
            return
        
        try:
            origen = int(parts[1])
            destino = int(parts[2])
        except ValueError:
            print("‚ùå Origen y destino deben ser n√∫meros enteros.")
            return
        
        ok = self.__juego.aplicar_movimiento(origen, destino)
        if ok:
            print("‚úÖ Movimiento aplicado correctamente.")
            self.mostrar_tablero_visual()
            
            # Verificar si quedan dados disponibles
            if not self.__juego.tiene_dados_disponibles():
                print("\n‚è≠Ô∏è  No quedan dados disponibles. Fin del turno.")
                self.__juego.cambiar_turno()
                jugador_actual = self.__juego.jugador_x.nombre if self.__juego.turno == 1 else self.__juego.jugador_o.nombre
                print(f"üîÑ Turno de {jugador_actual}")
        else:
            print("‚ùå Movimiento inv√°lido. Verifica:")
            print("   ‚Ä¢ Que tengas dados disponibles para ese movimiento")
            print("   ‚Ä¢ Que el punto de origen tenga tus fichas")
            print("   ‚Ä¢ Que el punto de destino no est√© bloqueado")
            print("   ‚Ä¢ Si tienes fichas en la barra, debes reingresarlas primero")

    def mostrar_estado(self):
        """
        Muestra el estado actual del juego de forma detallada.
        
        Incluye informaci√≥n sobre turno, dados y estado general.
        """
        print("\n" + "‚îÄ" * 70)
        print("üìä ESTADO DEL JUEGO")
        print("‚îÄ" * 70)
        print(self.__juego.descripcion())
        print("‚îÄ" * 70 + "\n")

    def reiniciar_juego(self):
        """Reinicia el juego y muestra confirmaci√≥n con tablero inicial."""
        self.__juego.reiniciar()
        print("\nüîÑ El juego se ha reiniciado correctamente\n")
        self.mostrar_tablero_visual()
        self.mostrar_estado()

    def salir(self):
        """Sale del juego mostrando un mensaje de despedida."""
        print("\n" + "=" * 70)
        print("\n          üëã Gracias por jugar Backgammon")
        print("                ¬°Hasta la pr√≥xima!")
        print("\n" + "=" * 70 + "\n")


def ejecutar_cli():
    """
    Funci√≥n auxiliar para ejecutar la CLI.
    
    Esta funci√≥n sirve como punto de entrada para iniciar
    la interfaz de l√≠nea de comandos del juego.
    """
    cli = BackgammonCLI()
    cli.iniciar()